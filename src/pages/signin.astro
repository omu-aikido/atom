---
import { default as Layout } from "@/atom/layouts/non-auth-layout.astro";
import ProgressCircle from "@/atom/components/ui/progress-circle.astro";
---

<Layout title="大阪公立大学合氣道部 - サインイン">
    <h1>Sign In</h1>
    <br />
    <form id="signin-form" class="signin-form">
        <div class="form-group">
            <label for="email">
                Email
                <span style="color:rgb(var(--maroon))">*</span>
            </label>
            <input type="email" name="email" placeholder="Email" required />
        </div>
        <div class="form-group">
            <label for="password">
                Password
                <span style="color:rgb(var(--maroon))">*</span>
            </label>
            <input
                type="password"
                name="password"
                placeholder="Password"
                required
            />
        </div>
        <div id="loading" class="loading" style="display: none;">
            <ProgressCircle title="サインイン中" inline="true" />
        </div>
        <button type="submit">Sign In</button>
    </form>
    <p>Don't have an account? <a href="/signup">Sign up here</a>.</p>
    <script>
        import { authClient } from "../lib/auh-client";
        const redirect = new URLSearchParams(window.location.search).get(
            "from"
        );
        const form = document.getElementById("signin-form");
        const loading = document.getElementById("loading");
        form?.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (loading) {
                loading.style.display = "block";
            }
            const formData = new FormData(e.target as HTMLFormElement);
            const email = formData.get("email") as string;
            const password = formData.get("password") as string;
            const tmp = await authClient.signIn.email({
                email,
                password,
            });
            const session = await authClient.getSession();
            if (loading) {
                loading.style.display = "none";
            }
            if (session?.data?.user.email || Boolean(tmp.error) === false) {
                if (redirect) {
                    window.location.href = redirect;
                } else {
                    window.location.href = "/app";
                }
                return;
            }
        });
    </script>
</Layout>

<style>
    form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-width: 300px;
        margin: 0 auto;
    }
    .signin-form {
        display: flex;
        flex-direction: column;
        justify-content: center;
        border-radius: 8px;
        padding: 1em;
        box-shadow: 0 0 8px 4px rgb(var(--shadow) / 0.3);
        max-width: fit-content;
        margin: auto;
    }

    .signin-form h1 {
        margin-bottom: 1.5rem;
        font-size: 2rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
    }

    .form-group input {
        padding: 0.75rem;
        border-radius: 4px;
        font-size: 1rem;
        width: 276px;
    }

    .signin-form button {
        padding: 0.75rem;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .loading {
        margin-top: 1rem;
        font-size: 1rem;
        color: rgb(var(--subtext1));
    }

    p {
        margin-top: 1rem;
    }

    p a {
        text-decoration: none;
    }

    p a:hover {
        text-decoration: underline;
    }
</style>
